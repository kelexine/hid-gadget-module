#!/bin/sh
# Universal hid-tui (C-based) wrapper with auto-recovery
ARCH=$(uname -m)
BASE_DIR="$(cd "$(dirname "$0")" && pwd)"

case "$ARCH" in
    aarch64|arm64) BIN="arm64" ;;
    arm*) BIN="arm" ;;
    x86_64|amd64) BIN="x86_64" ;;
    i*86) BIN="x86" ;;
    *) echo "Unsupported architecture: $ARCH"; exit 1 ;;
esac

HID_GADGET="$BASE_DIR/bin/$BIN/hid-gadget"

if [ ! -f "$HID_GADGET" ]; then
    echo "Error: hid-gadget binary not found for architecture $ARCH"
    exit 1
fi

if ! "$HID_GADGET" tui "$@"; then
    # Android specific recovery
    if [ -f "/system/bin/setprop" ] && command -v su >/dev/null; then
        echo "HID TUI failed, attempting auto-fix..."
        su -c "setprop sys.usb.config hid && hid-setup"
        exec "$HID_GADGET" tui "$@"
    fi
    exit 1
fi
